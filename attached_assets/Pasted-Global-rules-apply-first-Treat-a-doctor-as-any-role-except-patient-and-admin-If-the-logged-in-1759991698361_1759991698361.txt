Global rules (apply first)

Treat a “doctor” as any role except patient and admin.

If the logged-in user is a doctor:

Do not show the “Select Role” and “Select Name” dropdowns.

Instead, fetch the doctor’s role and name from the subdomain active user (use the organization_id) and display them as labels.

Doctors may only view and manage data that is linked to them (filter queries by created_by, doctor_id, or equivalent).

Add a created_by column to every relevant table (if it does not already exist). This column should record the user who created the record. Do not add created_by if it already exists.

For every insert operation in the modules below, ensure the backend sets created_by = logged_in_user_id (server-side enforcement).

Implement and test these global behaviors first, then proceed to file-specific changes.

Implementation & test order (apply sequentially)

Implement global rules & database migrations for created_by. Test reads/writes and “created by” display.

prescriptions.tsx — implement → test.

lab-results.tsx — implement → test.

imaging.tsx — implement → test.

shifts.tsx — implement → test.

billing.tsx — implement → test.

messaging.tsx — implement → test (including UI width adjustment).

forms.tsx — implement → test (file system save/load).

patients.tsx — implement → test.

financial-intelligence.tsx — implement → test.
(Only move to the next file after verifying tests for the current file pass.)

File-specific steps (do → test → next)
1) prescriptions.tsx

When “New Prescription” is clicked, open the “Create New Prescription” popup.

If the logged-in user is a doctor:

Retrieve the doctor’s role and name from the subdomain active user via organization_id.

Insert doctor details into the database only if required.

Replace the role/name dropdowns with read-only labels showing the doctor’s role and name. Do not remove the original components from code — conditionally render labels to preserve layout.

Replace the text “Provider undefined” with the doctor’s role and name.

Display “Gender at Birth” using the value from the users table.

Keep every other form field, behavior, and layout unchanged.

Ensure the record saved includes created_by = logged_in_user_id (server-side).

Test: open modal as doctor and non-doctor, confirm labels, confirm gender shows, verify created_by stored and displayed.

2) lab-results.tsx

When “Order Lab Test” is clicked, open the “Order Lab Test” popup.

If the logged-in user is a doctor:

Fetch doctor role and name from subdomain (organization_id).

Insert doctor details into the DB if needed.

Display role and name as labels instead of dropdowns.

Keep all other logic and layout unchanged.

Ensure created_by is set on insert (server-side).

Test: open modal as doctor and non-doctor, verify labels and saved created_by.

3) imaging.tsx

When “Order Study” is clicked, open “Upload Medical Images” popup.

If the logged-in user is a doctor:

Fetch doctor role and name from subdomain (organization_id).

If medical_imaging table lacks a created_by column, add it.

Insert the doctor’s ID into created_by when saving imaging records. (Optionally store name for denormalized display.)

Show role and name as labels in the modal (do not show dropdowns).

Keep all other logic and layout unchanged.

Test: confirm labels appear for doctor, confirm DB column exists or was added, verify created_by stored.

4) shifts.tsx

If the logged-in user is a doctor:

Fetch doctor role and name from subdomain (organization_id).

Hide the “Default Shifts” tab for doctors.

Provide a doctor-only UI to create shifts that belong only to that doctor.

Provide a search function allowing the doctor to view their own shifts by date.

Keep all other logic and layout unchanged.

Ensure shift records include created_by (server-side) and queries filter by created_by for doctors.

Test: confirm Default Shifts tab hidden, confirm doctor can create/view only their shifts, verify filtering and created_by.

5) billing.tsx

When “New Invoice” is clicked, open “Create New Invoice” popup.

If the logged-in user is a doctor:

Fetch doctor role and name from subdomain (organization_id).

Display the doctor’s name as a label on the form.

Always set created_by = logged_in_user_id on invoice creation (server-side).

After creation, show the invoice list with the creator’s name (lookup via created_by).

Additional behavior:

When a patient is selected in the invoice form, automatically display the patient’s NHS number from the database (do not require manual entry).

Keep all other logic and layout unchanged.

Test: create invoice as doctor, confirm label shows, confirm created_by stored, confirm NHS auto-populates.

6) messaging.tsx

If the logged-in user is a doctor:

Fetch doctor role and name from subdomain (organization_id).

For buttons Appointment Reminder, Lab Results, Prescription Ready, and Video Call, open “Compose New Message” popup.

Replace the *“Select Role ” and *“Select Name ” dropdowns with labels showing the doctor’s role and name. Hide those dropdowns.

Adjust the popup UI width to match the dashboard layout (increase width by ~1000px or align to dashboard width so it looks consistent). Apply responsive adjustments based on the dashboard container.

Keep all other logic and layout unchanged.

Ensure messages store sender id and created_by as appropriate.

Test: open compose popup as doctor and non-doctor, verify labels, width/layout, and that send works.

7) forms.tsx

For roles doctor, patient, and admin:

Fetch role and name from subdomain (organization_id).

When “Save Template” is clicked:

Save files to:

baseurl/uploads/Forms/{organization_id}/{user_id}/


If the directory path does not exist on the server, create it before saving.

Save metadata in DB with created_by = logged_in_user_id.

When “View Saved Templates” is clicked:

Fetch templates from baseurl/uploads/Forms/{organization_id}/{user_id}/ (use DB metadata and/or directory listing).

Provide create/read functions both for doctors and patients.

Keep all other logic and layout unchanged.

Test: save template as doctor and patient, verify directory created, verify file present and metadata, verify listing works.

8) patients.tsx

When “Add Patient” is clicked, open “Add New Patient” popup.

Add a section “Health Insurance Information (Optional)” with fields:

Insurance Provider

Plan Type

Policy Number

Member Number

NHS Number

When “Create Patient” is clicked:

Insert these values into the patients table.

Ensure created_by = logged_in_user_id is set.

Keep all other logic and layout unchanged.

Test: create patient with insurance data, verify DB insert and created_by.

9) financial-intelligence.tsx

Under “Insurance Verification”, when “Add Insurance Info” is clicked, open the “Add Insurance Information” popup.

When a Patient Name is selected:

Auto-fetch and display the patient’s NHS number and other stored details from the database (do not require manual re-entry).

Keep other logic and layout unchanged.

Test: verify selecting patient populates NHS and fields correctly.